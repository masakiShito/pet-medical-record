# 07_非機能設計（v2：領域別ページ設計対応）

## 1. 目的
本ドキュメントは、ペットカルテアプリ（MVP）の非機能要件を整理し、実装・運用での品質（性能/可用性/保守性/セキュリティ等）を担保するための基準を定義する。  
本v2では、**ホーム/ペットダッシュボードのサマリ表示**と、**通院・体重・投薬の領域別ページ化**に伴う非機能観点（取得方針・整合性・部分エラー等）を追記する。

---

## 2. 前提
- 個人開発 / 学習目的（将来公開・拡張も想定）
- 技術スタック：React（Vite）/ FastAPI / MySQL / Docker Compose
- 開発環境：Apple Silicon（arm64）
- MVPは認証なし（将来追加を前提に拡張可能な設計にする）
- 画面設計：ホーム（全体ダッシュボード）＋ペットダッシュボード（ハブ）＋領域別ページ（通院/体重/投薬）

---

## 3. 品質特性（優先順位）
MVPで優先する品質は以下。
1. **使いやすさ（UX）**：迷わず入力・振り返りができる（通院主役）
2. **信頼性（データ整合性）**：記録が消えない/壊れない/重複しない
3. **保守性**：将来の機能追加（添付、再診、ユーザー化）に耐える
4. **性能**：日常利用でストレスがない（一覧/サマリの表示速度）
5. **セキュリティ**：公開時に耐えうる基礎（CORS/入力検証/ログ）

---

## 4. 性能・スケーラビリティ
### 4.1 目標（MVP）
- 一覧表示（通院/体重/投薬/履歴）：**2秒以内**で初期描画（ローカル開発環境目安）
- 追加/更新：保存操作から完了表示まで **2秒以内**
- 1ペットあたりのデータ量：通院・体重・投薬 各 **〜数百件**を想定（当面はページング無しでも許容）

### 4.2 取得方針（N+1回避の方向性）
- S01/S04（ダッシュボード）は「ペット基本情報＋サマリ」を表示する。
  - MVP案：`GET /pets` + `GET /pets/{id}/summary` をペット数分呼ぶ（少数ペット前提で許容）
  - 将来案：`GET /pets?include=summary` 等で一括取得（N+1回避）
- 一覧API（通院/体重/投薬）は、将来ページング可能な形（limit/offset）を前提にする。

### 4.3 インデックス
- 通院：`visited_on`、体重：`measured_on`、投薬：`start_on/end_on`
- records：`(pet_id, recorded_on)`（ユニーク推奨）

---

## 5. 可用性・リカバリ
### 5.1 可用性（開発/MVP）
- Docker Composeで **1コマンド起動**できること
- `GET /health` と `GET /db/health` で稼働確認できること

### 5.2 リカバリ（データ保全）
- MySQLは永続化ボリュームを使用
- 開発時は「ボリューム削除＝初期化」であることをREADMEに明記
- 将来：定期バックアップ（mysqldump等）を検討

---

## 6. データ整合性（v2重要）
領域別APIを導入したため、**records（親）**と領域データ（通院/体重/投薬）の整合ルールを明文化する。

### 6.1 recordsの一意性
- 推奨：`records` に **(pet_id, recorded_on) のユニーク制約**
- これにより、領域別登録時に「同じ日付のrecordsを再利用」でき、重複を防げる

### 6.2 領域別登録時のrecords作成/取得ルール（必須）
- 通院作成：`visited_on` を `recorded_on` として records を **取得 or 作成**してから `record_vet_visits` を紐付け
- 体重作成：`measured_on` を `recorded_on` として同様
- 投薬作成：原則 `start_on` を `recorded_on` として同様（※要件により見直し可）

### 6.3 論理削除の整合
- 親（records）を削除した場合：子（通院/体重/投薬）は **同時に論理削除**が望ましい
- 子だけ削除した場合：親は残す（当日データが空になったら親削除するかはMVP外で良い）

---

## 7. エラーハンドリング（v2重要）
### 7.1 部分エラー（ダッシュボード）
- S01/S04 は **サマリ取得失敗でも画面全体は表示**する
  - サマリ部は「取得失敗」表示＋リトライ
  - ボタン（通院/体重/投薬）は利用可能

### 7.2 保存失敗
- 追加/編集フォームは、保存失敗時に **入力を保持**
- エラーメッセージは「何が原因か」を最短で示す（例：日付不正、必須不足）

### 7.3 エラーコード方針
- 404: NOT_FOUND（対象が存在しない）
- 409: CONFLICT（同日record重複など）
- 422: VALIDATION_ERROR（入力不正）
- 503: DB_UNAVAILABLE（DB疎通不可）

---

## 8. セキュリティ（MVP）
- CORS：開発環境のOriginに限定（例：localhost:5173）
- 入力バリデーション：Pydanticで型・範囲チェック
- 例外時にスタックトレースを外へ出さない（ログへ）
- 将来：認証導入時は `pets.user_id` を持たせ、全APIで所有者チェック（必須）

---

## 9. ログ・監査（v2追加）
- APIアクセスログ：method/path/status/latency/request_id
- 重要操作ログ：通院/体重/投薬/records の **作成・更新・削除**はINFO（削除はWARNでも可）
- エラー時：例外内容はログへ、クライアントには簡潔なメッセージ＋codeのみ返す
- request_id：レスポンスヘッダ or ボディに含める（デバッグ用）

---

## 10. テスト方針（MVP）
- 最低限：
  - ヘルスチェック（/health, /db/health）
  - 通院/体重/投薬：Create/Read/Update の結合テスト（backend）
  - records：履歴/詳細の取得テスト
- 将来：フロントE2E（Playwright等）

---

## 11. 制約・未決事項（MVP）
| 項目 | 状態 | メモ |
|---|---|---|
| 認証/認可 | 未対応 | 公開時に必須 |
| マルチユーザー | 未対応 | usersテーブルは拡張用 |
| 画像アップロード | MVP外 | 将来要検討 |
| オフライン対応 | MVP外 | PWA等で拡張可能 |
| 添付（領収書/検査結果） | MVP外 | record_attachments 等で拡張 |
| 再診管理 | MVP外 | next_visit_on 等で拡張 |
| N+1最適化 | 将来 | pets+summary一括取得など |

