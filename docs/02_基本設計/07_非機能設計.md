# 07_非機能設計（MVP）

## 1. 目的
本ドキュメントは、ペットカルテアプリ（MVP）の非機能要件を整理し、実装・運用での品質（性能/可用性/保守性/セキュリティ等）を担保するための基準を定義する。

---

## 2. 前提
- 個人開発 / 学習目的（将来公開・拡張も想定）
- 技術スタック：React（Vite）/ FastAPI / MySQL / Docker Compose
- 開発環境：Apple Silicon（arm64）
- MVPは認証なし（将来追加を前提に拡張可能な設計にする）

---

## 3. 品質特性（優先順位）
MVPで優先する品質特性は以下。

1. **使いやすさ（記録の継続性）**
2. **保守性（拡張しやすさ）**
3. **信頼性（データ喪失/不整合を避ける）**
4. **性能（体感が遅くない）**
5. **セキュリティ（最低限の防御）**

---

## 4. 性能（Performance）

### 4.1 目標値（MVP目安）
| 項目 | 目標 |
|---|---|
| 一覧表示（ペット一覧/記録一覧） | 体感1秒〜2秒以内 |
| 記録保存（新規/更新） | 2秒以内 |
| 初回ロード | 3秒以内（開発環境含む） |

※MVPの目標値。公開/ユーザー増加に合わせて再設計する。

### 4.2 性能対策（方針）
- 記録一覧取得は **期間指定（from/to）** と **limit** を基本にする
- DBインデックスを必須化  
  - `records(pet_id, recorded_on)`  
  - `pets(user_id, is_deleted)`
- N+1を避ける（records取得時の子要素は必要に応じてまとめて取得）
- React側は一覧で「すべての詳細」を初期ロードしない（詳細はS06で取得）

---

## 5. 可用性（Availability）/ 障害耐性

### 5.1 稼働確認
- `/health`：API稼働確認
- `/db/health`：DB疎通確認

### 5.2 コンテナ起動順序
- MySQLのヘルスチェックを行い、backendはDB準備完了後に起動する
- docker-composeで `depends_on` + `healthcheck` を利用する

### 5.3 データ保全
- MySQLは永続化ボリュームを使用
- 「削除」は論理削除を基本（誤操作対策）

---

## 6. セキュリティ（Security）

### 6.1 MVPで最低限やること
- CORS設定（許可Originを開発環境に限定）
- 入力バリデーション（Pydanticで型・範囲チェック）
- エラーメッセージに内部情報（SQL・スタック）を含めない
- DB接続情報を `.env` 管理し、`.env.example` を提供
- 依存ライブラリの脆弱性対応（定期的にアップデート）

### 6.2 将来拡張（公開を見据えた時）
- 認証（JWT/セッション）
- 認可（ユーザーIDによるデータアクセス制御）
- レート制限（API Gateway / middleware）
- 監査ログ（編集/削除履歴）

---

## 7. 信頼性（Reliability）/ データ整合性

### 7.1 トランザクション
- 記録保存（records + 子要素）を **トランザクション** で実施
  - 親作成→子作成が途中で失敗した場合はロールバック

### 7.2 外部キー制約
- `pets -> users`
- `records -> pets`
- `record_* -> records`

### 7.3 日付設計
- `recorded_on` は DATE（記録日）を基本
- 時刻が必要になったら `measured_at` 等の DATETIME を追加で対応

---

## 8. 保守性（Maintainability）/ 拡張性

### 8.1 バックエンド構成方針
- FastAPI：router / service / repository（またはcrud）/ schema / model を分離
- 共通例外ハンドリングを導入（HTTPExceptionの統一）
- OpenAPI（Swagger）を常に最新に保つ

### 8.2 フロントエンド構成方針
- 画面（pages）とコンポーネント（components）の責務分離
- API層（fetch client）を集中管理（例：`src/api/`）
- 入力フォームは共通化（record form / pet form）

### 8.3 拡張を前提とした設計
- `records` を親として子要素を追加するだけで拡張可能  
  （食事/排泄/ワクチン/検査結果など）

---

## 9. 運用（Operations）

### 9.1 ログ
- backend：Uvicornログ + アプリログ（INFO基準）
- エラー時は request_id（将来）を付与できる余地を残す

### 9.2 監視（MVP）
- まずは `/health` `/db/health` を手動確認できればOK
- 公開後は稼働監視（Uptime監視）を導入する

### 9.3 バックアップ
- MVPは手動バックアップでも良いが、公開を想定するなら定期バックアップ方針を用意
  - `mysqldump` を定期実行
  - 永続化ボリュームのスナップショット

---

## 10. 開発（Development）

### 10.1 環境分離
- `.env.example` を用意し、ローカルは `.env` で運用
- `DEV` / `PROD` の設定値を分離できるようにする（将来）

### 10.2 コーディング規約（最小）
- lint/format導入（frontend：ESLint/Prettier、backend：ruff/black等）
- 型を崩さない（Pydantic/TypeScript）

### 10.3 テスト方針（MVP）
- 最低限：ヘルスチェック、記録登録/取得の結合テスト（backend）
- 将来：フロントはE2E（Playwright等）

---

## 11. 制約・未決事項（MVP）
| 項目 | 状態 | メモ |
|---|---|---|
| 認証/認可 | 未対応 | 公開時に必須 |
| マルチユーザー | 未対応 | usersテーブルは拡張用 |
| 画像アップロード | MVP外 | 将来要検討 |
| オフライン対応 | MVP外 | PWA等で拡張可能 |

---
